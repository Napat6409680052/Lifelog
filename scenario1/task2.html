<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scenario 1 - Awareness Test (Sound)</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    .status-text {
      font-size: 0.9em;
      color: #888;
      margin-bottom: 10px;
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Scenario 1 (Awareness Test)</h2>
    <p><strong>Task <span id="taskOrder">2/4</span></strong></p>
    <p><strong>Trial <span id="trialNum">1</span> / 20</strong></p>

    <p id="statusText" class="status-text">Trial ‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
    <hr>

    <p class="question">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° : ‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÉ‡∏î ?</p>

    <div class="stimulus-area">
      <img src="./pic/picsound.png" width="250" alt="device sound">
    </div>

    <div class="btn-area">
      <button class="answer" data-choice="1">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥</button>
      <button class="answer" data-choice="2">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)</button>
      <button class="answer" data-choice="3">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á)</button>
      <button class="answer" data-choice="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
    </div>
  </div>

  <script>
    const pid = localStorage.getItem("pid") || "00";
    const taskOrder = JSON.parse(localStorage.getItem("taskOrder")) || ["LED","Sound","Vibration","None"];
    const taskName = "Sound";
    const taskIndex = taskOrder.indexOf(taskName) + 1;
    document.getElementById("taskOrder").textContent = `${taskIndex}/4`;


    const totalTrials = 20;
    const stimuli = ["normal","minor","critical","none"];
    const audioFolder = "./s1Sound/";
    const trialOrder = Array.from({length: totalTrials}, () => stimuli[Math.floor(Math.random() * stimuli.length)]);
    let currentTrial = 0, startTime, data = [];

    const trialNum = document.getElementById("trialNum");
    const statusText = document.getElementById("statusText");
    const answerBtns = document.querySelectorAll(".answer");

    loadTrial();

    function loadTrial() {
      if (currentTrial >= totalTrials) return showConfidence(true);
      trialNum.textContent = currentTrial + 1;

      // ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°
      statusText.style.display = "block";
      answerBtns.forEach(btn => btn.disabled = true);

      // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
      setTimeout(() => {
        statusText.style.display = "none";
        playStimulus();
        startTime = performance.now(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö RT ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        answerBtns.forEach(btn => btn.disabled = false);
      }, 2500);
    }

    function playStimulus() {
      const stim = trialOrder[currentTrial];
      const audio = new Audio(`${audioFolder}${stim}.mp3`);
      audio.play();
    }

    answerBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const rt = ((performance.now() - startTime) / 1000).toFixed(2);
        const userChoice = +btn.dataset.choice;
        const trueStim = trialOrder[currentTrial];
        const correctAns = getCorrectAnswer(trueStim);
        const isCorrect = userChoice === correctAns;

        data.push({
          pid, task: taskName, trial: currentTrial + 1,
          true_state: trueStim, user_response: userChoice,
          is_correct: isCorrect, rt_sec: rt
        });

        currentTrial++;
        if (currentTrial % 10 === 0 || currentTrial === totalTrials)
          showConfidence(currentTrial === totalTrials);
        else setTimeout(loadTrial, 600);
      });
    });

    function getCorrectAnswer(stim) {
      switch (stim) {
        case "normal": return 1;
        case "minor": return 2;
        case "critical": return 3;
        case "none": return 4;
      }
    }

    function showConfidence(isEnd=false) {
      const conf = prompt("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?\n( [1] ‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÄ‡∏•‡∏¢ - [5] ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î )","5");
      const confidence = parseInt(conf)||0;
      data.push({pid, task: taskName, confidence_1_5:confidence});

      if (isEnd) {
        alert(`‡∏à‡∏ö Task ${taskIndex}/4 ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ó‡∏≥ Task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`);
        saveAndNext();
      } else {
        alert("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠");
        loadTrial();
      }
    }

  // ‚úÖ ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á saveAndNext (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏•‡∏∞‡∏ï‡∏¥‡∏ô)
    function saveAndNext() {
      // üßæ 1) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á task ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      localStorage.setItem(`scenario1_data_${taskName}`, JSON.stringify(data));

      // üß† 2) ‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏•‡∏∞‡∏ï‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
      const order = JSON.parse(localStorage.getItem("taskOrder")) || ["LED", "Sound", "Vibration", "None"];
      const currentIndex = order.indexOf(taskName);
      const nextTask = order[currentIndex + 1]; // ‡∏´‡∏≤ task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏•‡∏∞‡∏ï‡∏¥‡∏ô

      // üó∫Ô∏è 3) mapping ‡∏ä‡∏∑‡πà‡∏≠ task ‚Üí ‡πÑ‡∏ü‡∏•‡πå
      const fileMap = {
        "LED": "task1.html",
        "Sound": "task2.html",
        "Vibration": "task3.html",
        "None": "task4.html"
      };

      // üß© 4) ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏´‡∏°
      if (nextTask) {
        // üîπ ‡∏¢‡∏±‡∏á‡∏°‡∏µ task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        alert(`‚úÖ ‡∏à‡∏ö Task ${currentIndex + 1}/4 ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÑ‡∏õ Task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (${nextTask})`);
        window.location.href = fileMap[nextTask];
      } else {
        // ‚úÖ ‡∏Ñ‡∏£‡∏ö 4/4 ‡πÅ‡∏•‡πâ‡∏ß
        alert("üéâ ‡∏à‡∏ö‡∏Ñ‡∏£‡∏ö 4/4 ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Scenario 2...");
        window.location.href = "../scenario2/instruction-sc2.html";
      }
    }
    
  </script>
</body>
</html>
