<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scenario 1 - Awareness Test (LED)</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    .status-text{font-size:.9em;color:#888;margin-bottom:10px;display:none}
    .center{text-align:center}
    .conf-btn{margin:0 6px;padding:8px 14px;border-radius:8px;border:1px solid #ccc;cursor:pointer}
    .conf-btn.selected{background:#3b82f6;color:#fff;border-color:#3b82f6}
    #confirmBtn[disabled]{opacity:.5;cursor:not-allowed}
    .note-msg{margin-top:14px;color:#555}
  </style>
</head>
<body>
  <div class="container">
    <h2>Scenario 1 (Awareness Test)</h2>
    <p><strong>Task <span id="taskOrder">1/4</span></strong></p>
    <p><strong>Trial <span id="trialNum">1</span> / 20</strong></p>

    <!-- ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 2.5 ‡∏ß‡∏¥ (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°) -->
    <p id="statusText" class="status-text">Trial ‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>

    <hr>
    <p class="question">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° : ‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÉ‡∏î ?</p>

    <div class="stimulus-area">
      <video id="ledVideo" width="250" muted playsinline></video>
    </div>

    <div class="btn-area">
      <button class="answer" data-choice="1">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥</button>
      <button class="answer" data-choice="2">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)</button>
      <button class="answer" data-choice="3">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á)</button>
      <button class="answer" data-choice="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
    </div>

    <!-- ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏ö‡∏ö Inline + ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏Å‡∏•‡∏á -->
    <div id="confidenceArea" class="center" style="display:none;margin-top:22px;">
      <p>‡∏Ñ‡∏∏‡∏ì‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?<br>( [1] ‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÄ‡∏•‡∏¢ ‚Äì [5] ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î )</p>
      <div id="confButtons" style="margin:10px 0;">
        <button class="conf-btn" data-conf="1">1</button>
        <button class="conf-btn" data-conf="2">2</button>
        <button class="conf-btn" data-conf="3">3</button>
        <button class="conf-btn" data-conf="4">4</button>
        <button class="conf-btn" data-conf="5">5</button>
      </div>
      <button id="confirmBtn" class="primary" disabled>‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>

    <p id="nextMsg" class="note-msg" style="display:none;"></p>
  </div>

  <script>
    const pid = localStorage.getItem("pid") || "00";
    const taskOrder = JSON.parse(localStorage.getItem("taskOrder")) || ["LED","Sound","Vibration","None"];
    const taskName = "LED";
    const taskIndex = taskOrder.indexOf(taskName) + 1;
    document.getElementById("taskOrder").textContent = `${taskIndex}/4`;

    const totalTrials = 20;
    const stimuli = ["green","yellow","red","off"];
    const videoFolder = "./s1LED/";
    const trialOrder = Array.from({length: totalTrials}, () => stimuli[Math.floor(Math.random()*stimuli.length)]);

    let currentTrial = 0, startTime, data = [];
    const video = document.getElementById("ledVideo");
    const trialNum = document.getElementById("trialNum");
    const statusText = document.getElementById("statusText");
    const answerBtns = document.querySelectorAll(".answer");
    const confidenceArea = document.getElementById("confidenceArea");
    const confButtons = document.querySelectorAll(".conf-btn");
    const confirmBtn = document.getElementById("confirmBtn");
    const nextMsg = document.getElementById("nextMsg");
    let selectedConfidence = null;
    let lastAnswer = null;

    window.addEventListener("load", loadTrial);

    function loadTrial() {
      if (currentTrial >= totalTrials) return endTask();
      trialNum.textContent = currentTrial + 1;

      // ‚úÖ Fixation/status 2.5s ‚Üí ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö RT (‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°):contentReference[oaicite:8]{index=8}
      statusText.style.display = "block";
      answerBtns.forEach(btn => btn.disabled = true);
      confidenceArea.style.display = "none";
      selectedConfidence = null; lastAnswer = null; confirmBtn.disabled = true;
      confButtons.forEach(b => b.classList.remove('selected'));

      setTimeout(() => {
        statusText.style.display = "none";
        playStimulus();
        startTime = performance.now(); // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö RT ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏ö 2.5s
        answerBtns.forEach(btn => btn.disabled = false);
      }, 2500);
    }

    function playStimulus() {
      const stim = trialOrder[currentTrial];
      video.src = `${videoFolder}${stim}.mp4`;
      video.currentTime = 0;
      video.play();
    }

    answerBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const rt = ((performance.now() - startTime) / 1000).toFixed(3);
        const userChoice = +btn.dataset.choice;
        const trueStim = trialOrder[currentTrial];
        const correctAns = getCorrectAnswer(trueStim);
        const isCorrect = userChoice === correctAns;

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏£‡∏±‡∏ö confidence
        lastAnswer = { pid, task: taskName, trial: currentTrial + 1,
          true_state: trueStim, user_response: userChoice, is_correct: isCorrect, rt_sec: rt };

        showConfidenceSection();
      });
    });

    function getCorrectAnswer(stim) {
      switch (stim) {
        case "green": return 1;
        case "yellow": return 2;
        case "red": return 3;
        case "off": return 4;
      }
    }

    function showConfidenceSection() {
      confidenceArea.style.display = "block";
      confirmBtn.disabled = true;
      selectedConfidence = null;
      confButtons.forEach(btn => {
        btn.onclick = () => {
          confButtons.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedConfidence = parseInt(btn.dataset.conf);
          confirmBtn.disabled = false;
        };
      });

      confirmBtn.onclick = () => {
        data.push({ ...lastAnswer, confidence: selectedConfidence });
        confidenceArea.style.display = "none";
        currentTrial++;
        // ‡πÑ‡∏õ trial ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        setTimeout(loadTrial, 300);
      };
    }

    function endTask() {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• task ‡∏ô‡∏µ‡πâ
      localStorage.setItem(`scenario1_data_${taskName}`, JSON.stringify(data));

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏•‡∏∞‡∏ï‡∏¥‡∏ô
      const order = taskOrder;
      const currentIndex = order.indexOf(taskName);
      const nextTask = order[currentIndex + 1];
      const fileMap = { "LED":"task1.html","Sound":"task2.html","Vibration":"task3.html","None":"task4.html" };

      if (nextTask) {
        nextMsg.style.display = "block";
        nextMsg.textContent = `‚úÖ ‡∏à‡∏ö Task ${currentIndex + 1}/4 ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ Task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (${nextTask})...`;
        setTimeout(()=> window.location.href = fileMap[nextTask], 1000);
      } else {
        // ‡∏Ñ‡∏£‡∏ö 4/4
        nextMsg.style.display = "block";
        nextMsg.innerHTML = `üéâ ‡∏à‡∏ö‡∏Ñ‡∏£‡∏ö 4/4 ‡πÅ‡∏•‡πâ‡∏ß <br><br><a href="../scenario2/instruction-sc2.html" class="primary" style="display:inline-block;padding:10px 16px;border-radius:8px;color:#fff;background:#007bff;text-decoration:none;">‡πÄ‡∏£‡∏¥‡πà‡∏° Instruction 2</a>`;
      }
    }
  </script>
</body>
</html>
