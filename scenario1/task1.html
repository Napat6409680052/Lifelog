<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scenario 1 - Task 1 (LED)</title>
  <link rel="stylesheet" href="../style.css">
  <script defer src="../script.js"></script>
</head>

<body>
  <div class="container">
    <h2 class="title">Scenario 1 (Awareness Test)</h2>
    <p><strong>Task <span id="taskOrder">1/4</span> : LED (‡πÅ‡∏™‡∏á)</strong></p>
    <p><strong>Trial <span id="trialNum">1</span> / 20</strong></p>
    <hr>

    <p class="question">
      ‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏´‡πá‡∏ô ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÉ‡∏î?
    </p>

    <div class="stimulus-area">
      <video id="ledVideo" width="250" autoplay muted playsinline></video>
    </div>

    <div class="btn-area">
      <button class="answer" data-choice="1">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥</button>
      <button class="answer" data-choice="2">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)</button>
      <button class="answer" data-choice="3">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á)</button>
      <button class="answer" data-choice="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
    </div>
  </div>

  <script>
    const pid = localStorage.getItem("pid") || "00";
    const taskName = "LED";
    const taskIndex = 1; // task 1/4
    const totalTrials = 20;

    const stimuli = ["green", "yellow", "red", "off"];
    const videoFolder = "./s1LED/";
    const trialOrder = [];
    for (let i = 0; i < totalTrials; i++) {
      trialOrder.push(stimuli[Math.floor(Math.random() * stimuli.length)]);
    }

    let currentTrial = 0;
    let startTime;
    let data = [];

    const video = document.getElementById("ledVideo");
    const trialNum = document.getElementById("trialNum");
    const answerBtns = document.querySelectorAll(".answer");

    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Trial ‡πÅ‡∏£‡∏Å
    loadTrial();

    function loadTrial() {
      if (currentTrial >= totalTrials) {
        showConfidence(true);
        return;
      }

      trialNum.textContent = currentTrial + 1;
      const stim = trialOrder[currentTrial];
      video.src = `${videoFolder}${stim}.mp4`;
      startTime = performance.now();

      answerBtns.forEach(btn => (btn.disabled = false));
    }

    answerBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const rt = ((performance.now() - startTime) / 1000).toFixed(2);
        const userChoice = parseInt(btn.dataset.choice);
        const trueStim = trialOrder[currentTrial];
        const correctAns = getCorrectAnswer(trueStim);
        const isCorrect = userChoice === correctAns;

        data.push({
          pid, task: taskName, trial: currentTrial + 1,
          true_state: trueStim, user_response: userChoice,
          is_correct: isCorrect, rt_sec: rt
        });

        currentTrial++;

        if (currentTrial % 10 === 0 || currentTrial === totalTrials) {
          showConfidence(currentTrial === totalTrials);
        } else {
          setTimeout(loadTrial, 600);
        }
      });
    });

    function getCorrectAnswer(stim) {
      switch (stim) {
        case "green": return 1;
        case "yellow": return 2;
        case "red": return 3;
        case "off": return 4;
      }
    }

    // üü© ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô popup ‡πÄ‡∏õ‡πá‡∏ô alert/prompt ‡∏à‡∏£‡∏¥‡∏á
    function showConfidence(isEnd = false) {
      const conf = prompt(
        "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?\n([1] ‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÄ‡∏•‡∏¢ ‚Äì [5] ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)",
        ""
      );

      const confidence = parseInt(conf) || 0;
      data.push({ pid, task: taskName, confidence_1_5: confidence });

      if (isEnd) {
        if (taskIndex === 4) {
          alert("‡∏à‡∏ö Task 4/4 ‡πÅ‡∏•‡πâ‡∏ß\n‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ Scenario 2");
          saveAndNext();
        } else {
          alert(`‡∏à‡∏ö Task ${taskIndex}/4 ‡πÅ‡∏•‡πâ‡∏ß\n‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`);
          saveAndNext();
        }
      } else {
        alert("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ");
        loadTrial();
      }
    }

    function saveAndNext() {
      localStorage.setItem("scenario1_data", JSON.stringify(data));

      if (taskIndex < 4) {
        window.location.href = `task${taskIndex + 1}.html`;
      } else {
        window.location.href = "../summary.html";
      }
    }
  </script>
</body>
</html>
