<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scenario 1 - Awareness Test (Vibration)</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    .status-text{font-size:.9em;color:#888;margin-bottom:10px;display:none}
    .center{text-align:center}
    .conf-btn{margin:0 6px;padding:8px 14px;border-radius:8px;border:1px solid #ccc;cursor:pointer}
    .conf-btn.selected{background:#3b82f6;color:#fff;border-color:#3b82f6}
    #confirmBtn[disabled]{opacity:.5;cursor:not-allowed}
    .note-msg{margin-top:14px;color:#555}
  </style>
</head>
<body>
  <div class="container">
    <h2>Scenario 1 (Awareness Test)</h2>
    <p><strong>Task <span id="taskOrder">3/4</span></strong></p>
    <p><strong>Trial <span id="trialNum">1</span> / 20</strong></p>

    <p id="statusText" class="status-text">Trial ‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
    <hr>

    <p class="question">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° : ‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÉ‡∏î ?</p>

    <div class="stimulus-area">
      <img src="./pic/picvibrate.png" width="250" alt="device vibration">
    </div>

    <div class="btn-area">
      <button class="answer" data-choice="1">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥</button>
      <button class="answer" data-choice="2">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)</button>
      <button class="answer" data-choice="3">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á)</button>
      <button class="answer" data-choice="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
    </div>

    <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à -->
    <div id="confidenceArea" class="center" style="display:none;margin-top:22px;">
      <p>‡∏Ñ‡∏∏‡∏ì‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?<br>( [1] ‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÄ‡∏•‡∏¢ ‚Äì [5] ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î )</p>
      <div id="confButtons" style="margin:10px 0;">
        <button class="conf-btn" data-conf="1">1</button>
        <button class="conf-btn" data-conf="2">2</button>
        <button class="conf-btn" data-conf="3">3</button>
        <button class="conf-btn" data-conf="4">4</button>
        <button class="conf-btn" data-conf="5">5</button>
      </div>
      <button id="confirmBtn" class="primary" disabled>‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>

    <p id="nextMsg" class="note-msg" style="display:none;"></p>
  </div>

<script>
  const pid = localStorage.getItem("pid") || "00";
  const taskOrder = JSON.parse(localStorage.getItem("taskOrder")) || ["LED","Sound","Vibration"];
  const taskName = "Vibration";
  const taskIndex = taskOrder.indexOf(taskName) + 1;
  document.getElementById("taskOrder").textContent = `${taskIndex}/${taskOrder.length}`;

  const totalTrials = 20;
  const stimuli = ["normal","minor","critical","none"];
  const trialOrder = Array.from({length: totalTrials}, () => stimuli[Math.floor(Math.random()*stimuli.length)]);
  let currentTrial = 0, startTime, data = [];

  const trialNum = document.getElementById("trialNum");
  const statusText = document.getElementById("statusText");
  const answerBtns = document.querySelectorAll(".answer");

  const confidenceArea = document.getElementById("confidenceArea");
  const confButtons = document.querySelectorAll(".conf-btn");
  const confirmBtn = document.getElementById("confirmBtn");
  const nextMsg = document.getElementById("nextMsg");
  let selectedConfidence = null; let lastAnswer = null;

  function vibratePattern(stim) {
    switch (stim) {
      case "normal":   navigator.vibrate([2000,2000,2000]); break;
      case "minor":    navigator.vibrate([200,200,200,200,200,200,200,200,200]); break;
      case "critical": navigator.vibrate([100,100,100,100,100,100,100,100,100,100,100]); break;
      case "none":     navigator.vibrate(0); break;
    }
  }

  loadTrial();

  function loadTrial() {
    if (currentTrial >= totalTrials) return endTask();
    trialNum.textContent = currentTrial + 1;

    statusText.style.display = "block";
    answerBtns.forEach(btn => btn.disabled = true);
    confidenceArea.style.display = "none";
    selectedConfidence = null; lastAnswer = null; confirmBtn.disabled = true;
    confButtons.forEach(b => b.classList.remove('selected'));

    setTimeout(() => {
      statusText.style.display = "none";
      playStimulus();
      startTime = performance.now(); // RT ‡∏´‡∏•‡∏±‡∏á 2.5s
      answerBtns.forEach(btn => btn.disabled = false);
    }, 2500);
  }

  function playStimulus() {
    const stim = trialOrder[currentTrial];
    vibratePattern(stim);
  }

  answerBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const rt = ((performance.now() - startTime) / 1000).toFixed(3);
      const userChoice = +btn.dataset.choice;
      const trueStim = trialOrder[currentTrial];
      const correctAns = getCorrectAnswer(trueStim);
      const isCorrect = userChoice === correctAns;

      lastAnswer = { 
        pid, task: taskName, trial: currentTrial + 1,
        true_state: trueStim, user_response: userChoice,
        is_correct: isCorrect, rt_sec: rt 
      };

      showConfidenceSection();
    });
  });

  function getCorrectAnswer(stim) {
    switch (stim) {
      case "normal": return 1;
      case "minor": return 2;
      case "critical": return 3;
      case "none": return 4;
    }
  }

  function showConfidenceSection() {
    confidenceArea.style.display = "block";
    confirmBtn.disabled = true;
    selectedConfidence = null;
    confButtons.forEach(btn => {
      btn.onclick = () => {
        confButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedConfidence = parseInt(btn.dataset.conf);
        confirmBtn.disabled = false;
      };
    });

    confirmBtn.onclick = () => {
      data.push({ ...lastAnswer, confidence: selectedConfidence });
      confidenceArea.style.display = "none";
      currentTrial++;
      setTimeout(loadTrial, 300);
    };
  }

  function endTask() {
    // 1) ‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• trial-level ‡∏Ç‡∏≠‡∏á task ‡∏ô‡∏µ‡πâ
    localStorage.setItem(`scenario1_data_${taskName}`, JSON.stringify(data));

    const order = taskOrder;
    const currentIndex = order.indexOf(taskName);
    const nextTask = order[currentIndex + 1];
    const totalTasks = order.length;
    const fileMap = { 
      "LED":"task1.html",
      "Sound":"task2.html",
      "Vibration":"task3.html"
    };

    if (nextTask) {
      nextMsg.style.display = "block";
      nextMsg.textContent = `‚úÖ ‡∏à‡∏ö Task ${currentIndex + 1}/${totalTasks} ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ Task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (${nextTask})...`;
      setTimeout(()=> window.location.href = fileMap[nextTask], 1000);
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ task ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ = ‡∏à‡∏ö Scenario 1 ‚Üí ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏ó‡∏∏‡∏Å task ‡πÄ‡∏õ‡πá‡∏ô result_scenario1

      const ledData   = JSON.parse(localStorage.getItem("scenario1_data_LED") || "[]");
      const soundData = JSON.parse(localStorage.getItem("scenario1_data_Sound") || "[]");
      const vibData   = JSON.parse(localStorage.getItem("scenario1_data_Vibration") || "[]");

      function summarizeTask(taskName, arr) {
        if (!arr.length) return null;
        let correct = 0, wrong = 0;
        let sumRT = 0, rtCount = 0;
        let sumConf = 0, confCount = 0;

        arr.forEach(tr => {
          if (tr.is_correct) correct++; else wrong++;
          const rt = parseFloat(tr.rt_sec);
          if (!isNaN(rt)) { sumRT += rt; rtCount++; }
          const conf = Number(tr.confidence);
          if (!isNaN(conf)) { sumConf += conf; confCount++; }
        });

        return {
          task: taskName,
          correct,
          wrong,
          rt_avg: rtCount ? (sumRT / rtCount).toFixed(3) : "-",
          avg_confidence: confCount ? (sumConf / confCount).toFixed(2) : "-"
        };
      }

      const tasksSummary = [];
      const s1_led = summarizeTask("LED", ledData);
      const s1_sound = summarizeTask("Sound", soundData);
      const s1_vib = summarizeTask("Vibration", vibData);
      if (s1_led) tasksSummary.push(s1_led);
      if (s1_sound) tasksSummary.push(s1_sound);
      if (s1_vib) tasksSummary.push(s1_vib);

      const participant = JSON.parse(localStorage.getItem("participant_info") || "{}");

      const resultScenario1 = {
        scenario: "Scenario 1",
        pid: localStorage.getItem("pid") || (participant.fullName || ""),
        group: participant.group || "",
        tasks: tasksSummary
      };

      localStorage.setItem("result_scenario1", JSON.stringify(resultScenario1));

      alert(`üéâ ‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö Task ${totalTasks}/${totalTasks} ‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏î‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á Scenario 2`);
      window.location.href = "../scenario2/instruction-sc2.html";
    }
  }
</script>

</body>
</html>
