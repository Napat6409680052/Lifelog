<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scenario 1 – Task 1 (LED)</title>
  <link rel="stylesheet" href="../style.css">
</head>

<body>
  <div class="container">
    <h2>Scenario 1 (Awareness Test)</h2>
    <p><strong>Task 1 / 4 : LED (แสง)</strong></p>
    <p><strong>Trial <span id="trialNum">1</span> / 20</strong></p>
    <hr>

    <p class="question">จากสัญญาณที่ท่านเห็น อุปกรณ์นี้กำลังทำงานอยู่หรือไม่ และอยู่ในสภาพใด?</p>
    <video id="stimVideo" width="250" autoplay muted playsinline></video>

    <div class="btn-area">
      <button class="answer" data-choice="1">ทำงานอยู่และปกติ</button>
      <button class="answer" data-choice="2">ทำงานอยู่แต่ผิดปกติ (เล็กน้อย)</button>
      <button class="answer" data-choice="3">ทำงานอยู่แต่ผิดปกติ (รุนแรง)</button>
      <button class="answer" data-choice="4">ไม่มีการทำงาน</button>
    </div>
  </div>

  <script>
    const pid = localStorage.getItem("pid");
    const taskIndex = 1;
    const totalTrials = 20;
    const stimuli = ["green", "yellow", "red", "off"];
    const folder = "./s1LED/";
    let currentTrial = 0, startTime, data = [];

    const video = document.getElementById("stimVideo");
    const trialNum = document.getElementById("trialNum");
    const btns = document.querySelectorAll(".answer");

    startTrial();
    function startTrial() {
      if (currentTrial >= totalTrials) { showConfidence(true); return; }
      const stim = stimuli[Math.floor(Math.random()*4)];
      video.src = `${folder}${stim}.mp4`;
      trialNum.textContent = currentTrial+1;
      startTime = performance.now();
      btns.forEach(b => b.disabled=false);
    }

    btns.forEach(b=>{
      b.addEventListener("click",()=>{
        const rt = ((performance.now()-startTime)/1000).toFixed(2);
        const resp = +b.dataset.choice;
        const stim = video.src.split("/").pop().replace(".mp4","");
        const correct = {green:1,yellow:2,red:3,off:4}[stim];
        data.push({pid,task:"LED",trial:currentTrial+1,stim,resp,correct,isCorrect:resp===correct,rt});
        currentTrial++;
        if(currentTrial%10===0||currentTrial===totalTrials) showConfidence(currentTrial===totalTrials);
        else setTimeout(startTrial,500);
      });
    });

    function showConfidence(end=false){
      const conf = prompt("คุณมั่นใจแค่ไหนว่ารับรู้ได้ถูกต้อง?\n(1 = ไม่มั่นใจเลย – 5 = มั่นใจที่สุด)","");
      data.push({pid,task:"LED",confidence:+conf||0});
      if(end){
        alert("จบ Task 1/4 แล้ว → ทำ Task ถัดไป");
        localStorage.setItem("scenario1_data",JSON.stringify(data));
        window.location.href="taskSound.html";
      }else{
        alert("ขอบคุณค่ะ ดำเนินการต่อ");
        startTrial();
      }
    }
  </script>
</body>
</html>
