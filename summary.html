<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‚Äì Lifelogging Usability Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: "Sarabun", sans-serif;
      background: #f5f6f8;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 10px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 640px;
      width: 100%;
      text-align: center;
    }
    h2 { margin-bottom: 10px; color:#333; }
    p.desc { color:#555; line-height:1.6; margin-bottom:25px; }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover { background:#0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á üéâ</h2>
    <p class="desc">
      ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ã‡∏µ‡∏ô‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡πÇ‡∏≠‡πâ‡πÅ‡∏•‡πâ‡∏ß<br>
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      <br>‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
    </p>

    <button id="downloadBtn">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel</button>
  </div>

  <script>
    document.getElementById("downloadBtn").addEventListener("click", exportExcel);

    function exportExcel() {
      const s1 = JSON.parse(localStorage.getItem("result_scenario1") || "null");
      const s2 = JSON.parse(localStorage.getItem("result_scenario2") || "null");
      if (!s1 || !s2) {
        alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ã‡∏µ‡∏ô‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡πÇ‡∏≠‡πâ");
        return;
      }

      // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Scenario 1
      const s1Rows = (s1.tasks || []).map(t => ({
        PID: s1.pid,
        Group: s1.group,
        Scenario: "Scenario 1 (‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì)",
        TaskOrImage: t.task,
        Correct: t.correct,
        Wrong: t.wrong,
        ReactionTime: t.rt_avg || "-",
        Confidence: t.avg_confidence || "-"
      }));

      // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Scenario 2
      const s2Rows = (s2.trials || []).map(t => ({
        PID: s2.pid,
        Group: s2.group,
        Scenario: "Scenario 2 (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏ã)",
        TaskOrImage: t.image,
        Correct: t.correct,
        Wrong: t.wrong,
        TotalClicks: t.total_clicks,
        Solved: t.solved ? "TRUE" : "FALSE",
        Confidence: t.confidence
      }));

      const allRows = [...s1Rows, ...s2Rows];

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      let g1 = JSON.parse(localStorage.getItem("excel_group1") || "[]");
      let g2 = JSON.parse(localStorage.getItem("excel_group2") || "[]");

      // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° group
      if (s1.group === "1" || s2.group === "1") g1.push(...allRows);
      else if (s1.group === "2" || s2.group === "2") g2.push(...allRows);
      else alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏´‡∏£‡∏∑‡∏≠ 2)");

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∞‡∏™‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage
      localStorage.setItem("excel_group1", JSON.stringify(g1));
      localStorage.setItem("excel_group2", JSON.stringify(g2));

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á workbook
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(g1);
      const ws2 = XLSX.utils.json_to_sheet(g2);

      XLSX.utils.book_append_sheet(wb, ws1, "Group 1 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢)");
      XLSX.utils.book_append_sheet(wb, ws2, "Group 2 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢)");

      XLSX.writeFile(wb, "Lifelogging_Results.xlsx");
    }
  </script>
</body>
</html>
