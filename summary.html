<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‚Äì Lifelogging Usability Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: "Sarabun", sans-serif;
      background: #f5f6f8;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 10px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 640px;
      width: 100%;
      text-align: center;
    }
    h2 { margin-bottom: 10px; color:#333; }
    p.desc { color:#555; line-height:1.6; margin-bottom:25px; }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover { background:#0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á üéâ</h2>
    <p class="desc">
      ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ã‡∏µ‡∏ô‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡πÇ‡∏≠‡πâ‡πÅ‡∏•‡πâ‡∏ß<br>
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      <br>‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
    </p>

    <button id="downloadBtn">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel (‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏Å Trial + ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°)</button>
  </div>

  <script>
    document.getElementById("downloadBtn").addEventListener("click", exportExcel);

    function exportExcel() {
      // ‡∏ú‡∏•‡∏£‡∏ß‡∏° Scenario 1 / 2 (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô flag + ‡πÅ‡∏´‡∏•‡πà‡∏á PID / group)
      var s1 = JSON.parse(localStorage.getItem("result_scenario1") || "null");
      var s2 = JSON.parse(localStorage.getItem("result_scenario2") || "null");
      var participant = JSON.parse(localStorage.getItem("participant_info") || "null");
      var sus = JSON.parse(localStorage.getItem("sus_result") || "null");
      var pssuq = JSON.parse(localStorage.getItem("pssuq_result") || "null");

      if (!s1 || !s2) {
        alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ã‡∏µ‡∏ô‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡πÇ‡∏≠‡πâ");
        return;
      }

      var pidValue =
        (s1 && s1.pid) ||
        (s2 && s2.pid) ||
        (participant && participant.fullName) ||
        "";

      var groupValueRaw =
        (s1 && s1.group) ||
        (s2 && s2.group) ||
        (participant && participant.group) ||
        localStorage.getItem("group") ||
        "";

      var groupValue = String(groupValueRaw);

      // ====== Scenario 1: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏Å trial ‡∏à‡∏≤‡∏Å 3 task ======
      var ledTrials   = JSON.parse(localStorage.getItem("scenario1_data_LED") || "[]");
      var soundTrials = JSON.parse(localStorage.getItem("scenario1_data_Sound") || "[]");
      var vibTrials   = JSON.parse(localStorage.getItem("scenario1_data_Vibration") || "[]");

      var s1TrialsAll = []
        .concat(ledTrials, soundTrials, vibTrials)
        .map(function(t) {
          return {
            PID: pidValue,
            GroupRaw: groupValue,
            Scenario: "Scenario 1 (‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì)",
            Task: t.task || "",
            Trial: t.trial || "",
            TrueState: t.true_state || "",
            Response: t.user_response != null ? t.user_response : "",
            Correct: t.is_correct ? 1 : 0,
            RT_sec: t.rt_sec != null ? t.rt_sec : "",
            Confidence: t.confidence != null ? t.confidence : ""
          };
        });

      // ====== Scenario 2: ‡πÅ‡∏ñ‡∏ß‡∏•‡∏∞ 1 ‡∏†‡∏≤‡∏û + click logs ‡πÄ‡∏õ‡πá‡∏ô JSON ======
      var s2Trials = (s2 && Array.isArray(s2.trials)) ? s2.trials : [];

      var s2Rows = s2Trials.map(function(tr) {
        return {
          PID: pidValue,
          GroupRaw: groupValue,
          Scenario: "Scenario 2 (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏ã)",
          Image: tr.image || "",
          CorrectCount: tr.correct != null ? tr.correct : "",
          WrongCount: tr.wrong != null ? tr.wrong : "",
          TotalClicks: tr.total_clicks != null ? tr.total_clicks : "",
          Solved: tr.solved ? "TRUE" : "FALSE",
          Confidence: tr.confidence != null ? tr.confidence : "",
          ClickLogsJSON: JSON.stringify(tr.clicks || [])
        };
      });

      // ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô (Scenario 1 + Scenario 2)
      var allRows = s1TrialsAll.concat(s2Rows);

      // ====== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏î‡∏¥‡∏° (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô) ======
      var g1 = JSON.parse(localStorage.getItem("excel_group1") || "[]");
      var g2 = JSON.parse(localStorage.getItem("excel_group2") || "[]");

      // ‡∏Å‡∏•‡∏∏‡πà‡∏° 1: 1 / Well-being / ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢" / "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1"
      var isGroup1 =
        groupValue === "1" ||
        groupValue === "Well-being" ||
        groupValue.indexOf("‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢") !== -1 ||
        groupValue.indexOf("‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1") !== -1;

      if (isGroup1) {
        g1 = g1.concat(allRows);
      } else {
        g2 = g2.concat(allRows);
      }

      // ‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∞‡∏™‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á localStorage
      localStorage.setItem("excel_group1", JSON.stringify(g1));
      localStorage.setItem("excel_group2", JSON.stringify(g2));

      // ====== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• META: Screening + SUS + PSSUQ (1 ‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô) ======
      var susAnswers = (sus && Array.isArray(sus.answers)) ? sus.answers : [];
      var pssAnswers = (pssuq && Array.isArray(pssuq.answers)) ? pssuq.answers : [];

      function getVal(arr, idx) {
        return (arr && arr.length > idx) ? arr[idx] : "";
      }

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì SUS Score (‡∏ï‡∏≤‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 0‚Äì100)
      var susScore = "";
      if (susAnswers.length === 10) {
        var susSum = 0;
        for (var i = 0; i < 10; i++) {
          var v = Number(susAnswers[i]);
          if (isNaN(v)) continue;
          if ((i + 1) % 2 === 1) {
            // ‡∏Ç‡πâ‡∏≠‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏µ‡πà
            susSum += (v - 1);
          } else {
            // ‡∏Ç‡πâ‡∏≠‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡πà
            susSum += (5 - v);
          }
        }
        susScore = (susSum * 2.5).toFixed(2);
      }

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PSSUQ Average
      var pssAvg = "";
      if (pssAnswers.length > 0) {
        var pSum = 0;
        var pCount = 0;
        for (var j = 0; j < pssAnswers.length; j++) {
          var pv = Number(pssAnswers[j]);
          if (!isNaN(pv)) {
            pSum += pv;
            pCount++;
          }
        }
        if (pCount > 0) {
          pssAvg = (pSum / pCount).toFixed(2);
        }
      }

      var metaRow = {
        PID: pidValue,
        GroupRaw: groupValue,
        GroupLabel: isGroup1 ? "Group 1 (‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢)" : "Group 2 (‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢)",

        FullName: participant && participant.fullName ? participant.fullName : "",
        Age: participant && participant.age != null ? participant.age : "",
        Gender: participant && participant.gender ? participant.gender : "",
        UsedWearable: participant && participant.usedWearable ? participant.usedWearable : "",
        UsageFreq: participant && participant.usageFreq ? participant.usageFreq : "",

        SUS_Q1: getVal(susAnswers, 0),
        SUS_Q2: getVal(susAnswers, 1),
        SUS_Q3: getVal(susAnswers, 2),
        SUS_Q4: getVal(susAnswers, 3),
        SUS_Q5: getVal(susAnswers, 4),
        SUS_Q6: getVal(susAnswers, 5),
        SUS_Q7: getVal(susAnswers, 6),
        SUS_Q8: getVal(susAnswers, 7),
        SUS_Q9: getVal(susAnswers, 8),
        SUS_Q10: getVal(susAnswers, 9),
        SUS_Score: susScore,
        SUS_CreatedAt: sus && sus.createdAt ? sus.createdAt : "",

        PSSUQ_Q1:  getVal(pssAnswers, 0),
        PSSUQ_Q2:  getVal(pssAnswers, 1),
        PSSUQ_Q3:  getVal(pssAnswers, 2),
        PSSUQ_Q4:  getVal(pssAnswers, 3),
        PSSUQ_Q5:  getVal(pssAnswers, 4),
        PSSUQ_Q6:  getVal(pssAnswers, 5),
        PSSUQ_Q7:  getVal(pssAnswers, 6),
        PSSUQ_Q8:  getVal(pssAnswers, 7),
        PSSUQ_Q9:  getVal(pssAnswers, 8),
        PSSUQ_Q10: getVal(pssAnswers, 9),
        PSSUQ_Q11: getVal(pssAnswers, 10),
        PSSUQ_Q12: getVal(pssAnswers, 11),
        PSSUQ_Q13: getVal(pssAnswers, 12),
        PSSUQ_Q14: getVal(pssAnswers, 13),
        PSSUQ_Q15: getVal(pssAnswers, 14),
        PSSUQ_Q16: getVal(pssAnswers, 15),
        PSSUQ_Avg: pssAvg,
        PSSUQ_CreatedAt: pssuq && pssuq.createdAt ? pssuq.createdAt : ""
      };

      // ‡πÇ‡∏´‡∏•‡∏î/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï meta ‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å localStorage (‡∏™‡∏∞‡∏™‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)
      var metaAll = JSON.parse(localStorage.getItem("excel_meta") || "[]");
      metaAll.push(metaRow);
      localStorage.setItem("excel_meta", JSON.stringify(metaAll));

      // ====== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏°‡∏µ 3 ‡∏ä‡∏µ‡∏ó ======
      var wb = XLSX.utils.book_new();
      var ws1 = XLSX.utils.json_to_sheet(g1);
      var ws2 = XLSX.utils.json_to_sheet(g2);
      var wsMeta = XLSX.utils.json_to_sheet(metaAll);

      XLSX.utils.book_append_sheet(wb, ws1, "Group 1 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢)");
      XLSX.utils.book_append_sheet(wb, ws2, "Group 2 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢)");
      XLSX.utils.book_append_sheet(wb, wsMeta, "Meta (Screen+SUS+PSSUQ)");

      XLSX.writeFile(wb, "Lifelogging_Results.xlsx");
    }
  </script>
</body>
</html>
