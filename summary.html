<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‚Äì Lifelogging Usability Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: "Sarabun", sans-serif;
      background: #f5f6f8;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 10px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 640px;
      width: 100%;
      text-align: center;
    }
    h2 { margin-bottom: 10px; color:#333; }
    p.desc { color:#555; line-height:1.6; margin-bottom:25px; }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover { background:#0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á üéâ</h2>
    <p class="desc">
      ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ã‡∏µ‡∏ô‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡πÇ‡∏≠‡πâ‡πÅ‡∏•‡πâ‡∏ß<br>
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      <br>‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
    </p>

    <button id="downloadBtn">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel (‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏Å Trial)</button>
  </div>

  <script>
    document.getElementById("downloadBtn").addEventListener("click", exportExcel);

    function exportExcel() {
      // ‡∏ú‡∏•‡∏£‡∏ß‡∏° Scenario 1 / 2 (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô flag + ‡πÅ‡∏´‡∏•‡πà‡∏á PID / group)
      const s1 = JSON.parse(localStorage.getItem("result_scenario1") || "null");
      const s2 = JSON.parse(localStorage.getItem("result_scenario2") || "null");
      const participant = JSON.parse(localStorage.getItem("participant_info") || "null");

      if (!s1 || !s2) {
        alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ã‡∏µ‡∏ô‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡πÇ‡∏≠‡πâ");
        return;
      }

      const pidValue =
        (s1 && s1.pid) ||
        (s2 && s2.pid) ||
        (participant && participant.fullName) ||
        "";

      const groupValueRaw =
        (s1 && s1.group) ||
        (s2 && s2.group) ||
        (participant && participant.group) ||
        localStorage.getItem("group") ||
        "";

      const groupValue = String(groupValueRaw);

      // ====== Scenario 1: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏Å trial ‡∏à‡∏≤‡∏Å 3 task ======
      const ledTrials   = JSON.parse(localStorage.getItem("scenario1_data_LED") || "[]");
      const soundTrials = JSON.parse(localStorage.getItem("scenario1_data_Sound") || "[]");
      const vibTrials   = JSON.parse(localStorage.getItem("scenario1_data_Vibration") || "[]");

      const s1TrialsAll = []
        .concat(ledTrials, soundTrials, vibTrials)
        .map(t => ({
          PID: pidValue,
          GroupRaw: groupValue,
          Scenario: "Scenario 1 (‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì)",
          Task: t.task || "",
          Trial: t.trial || "",
          TrueState: t.true_state || "",
          Response: t.user_response != null ? t.user_response : "",
          Correct: t.is_correct ? 1 : 0,
          RT_sec: t.rt_sec != null ? t.rt_sec : "",
          Confidence: t.confidence != null ? t.confidence : ""
        }));

      // ====== Scenario 2: ‡πÅ‡∏ñ‡∏ß‡∏•‡∏∞ 1 ‡∏†‡∏≤‡∏û + ‡πÄ‡∏Å‡πá‡∏ö click logs ‡πÄ‡∏õ‡πá‡∏ô JSON ======
      const s2Trials = Array.isArray(s2.trials) ? s2.trials : [];

      const s2Rows = s2Trials.map(tr => ({
        PID: pidValue,
        GroupRaw: groupValue,
        Scenario: "Scenario 2 (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏ã)",
        Image: tr.image || "",
        CorrectCount: tr.correct != null ? tr.correct : "",
        WrongCount: tr.wrong != null ? tr.wrong : "",
        TotalClicks: tr.total_clicks != null ? tr.total_clicks : "",
        Solved: tr.solved ? "TRUE" : "FALSE",
        Confidence: tr.confidence != null ? tr.confidence : "",
        ClickLogsJSON: JSON.stringify(tr.clicks || [])
      }));

      // ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô (Scenario 1 + Scenario 2)
      const allRows = [...s1TrialsAll, ...s2Rows];

      // ====== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏î‡∏¥‡∏° (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô) ======
      let g1 = JSON.parse(localStorage.getItem("excel_group1") || "[]");
      let g2 = JSON.parse(localStorage.getItem("excel_group2") || "[]");

      // ‡∏Å‡∏•‡∏∏‡πà‡∏° 1: 1 / Well-being / ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢" / "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1"
      const isGroup1 =
        groupValue === "1" ||
        groupValue === "Well-being" ||
        groupValue.includes("‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢") ||
        groupValue.includes("‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1");

      if (isGroup1) {
        g1.push(...allRows);
      } else {
        // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô Group 2 (Non-user / ‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢ ‡∏Ø‡∏•‡∏Ø)
        g2.push(...allRows);
      }

      // ‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∞‡∏™‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á localStorage
      localStorage.setItem("excel_group1", JSON.stringify(g1));
      localStorage.setItem("excel_group2", JSON.stringify(g2));

      // ====== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏°‡∏µ 2 ‡∏ä‡∏µ‡∏ó (Group 1 / Group 2) ======
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(g1);
      const ws2 = XLSX.utils.json_to_sheet(g2);

      XLSX.utils.book_append_sheet(wb, ws1, "Group 1 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢)");
      XLSX.utils.book_append_sheet(wb, ws2, "Group 2 (‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢)");

      XLSX.writeFile(wb, "Lifelogging_Results.xlsx");
    }
  </script>
</body>
</html>
